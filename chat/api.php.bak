<?php
/**
 * API del Sistema de Chat en Tiempo Real
 */

require_once __DIR__ . '/../db.php';
require_once __DIR__ . '/config.php';

header('Content-Type: application/json');

// Verificar sesión
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['success' => false, 'error' => 'No autorizado']);
    exit;
}

$userId = (int)$_SESSION['user_id'];

// Leer el body una sola vez al inicio
$rawInput = file_get_contents('php://input');
$jsonData = $rawInput ? json_decode($rawInput, true) : null;

// Obtener action del JSON body o query string
$action = ($jsonData['action'] ?? null) ?: ($_GET['action'] ?? $_POST['action'] ?? '');

// Debug mejorado
error_log('=== CHAT API DEBUG ===');
error_log('Method: ' . $_SERVER['REQUEST_METHOD']);
error_log('Content-Type: ' . ($_SERVER['CONTENT_TYPE'] ?? 'not set'));
error_log('Raw Input Length: ' . strlen($rawInput));
error_log('Raw Input: ' . $rawInput);
error_log('JSON Decode Error: ' . json_last_error_msg());
error_log('JSON Data: ' . var_export($jsonData, true));
error_log('GET: ' . var_export($_GET, true));
error_log('POST: ' . var_export($_POST, true));
error_log('Action resolved: ' . var_export($action, true));
error_log('=== END DEBUG ===');

// Si no hay action, devolver error detallado
if (empty($action)) {
    http_response_code(400);
    echo json_encode([
        'success' => false,
        'error' => 'Acción no válida',
        'debug' => [
            'method' => $_SERVER['REQUEST_METHOD'],
            'content_type' => $_SERVER['CONTENT_TYPE'] ?? 'not set',
            'raw_input_length' => strlen($rawInput),
            'json_error' => json_last_error_msg(),
            'has_json_data' => $jsonData !== null,
            'has_get_action' => isset($_GET['action']),
            'has_post_action' => isset($_POST['action'])
        ]
    ]);
    exit;
}

try {
    switch ($action) {
        case 'get_conversations':
            getConversations($pdo, $userId);
            break;
            
        case 'get_messages':
            $conversationId = (int)($_GET['conversation_id'] ?? 0);
            $lastMessageId = (int)($_GET['last_message_id'] ?? 0);
            getMessages($pdo, $userId, $conversationId, $lastMessageId);
            break;
            
        case 'send_message':
            if ($jsonData === null) {
                http_response_code(400);
                echo json_encode(['success' => false, 'error' => 'Invalid JSON']);
                break;
            }
            sendMessage($pdo, $userId, $jsonData);
            break;
            
        case 'create_conversation':
            if ($jsonData === null) {
                http_response_code(400);
                echo json_encode([
                    'success' => false, 
                    'error' => 'Invalid JSON or empty body',
                    'method' => $_SERVER['REQUEST_METHOD'],
                    'raw_input' => $rawInput,
                    'content_type' => $_SERVER['CONTENT_TYPE'] ?? 'not set',
                    'json_error' => json_last_error_msg()
                ]);
                break;
            }
            
            createConversation($pdo, $userId, $jsonData);
            break;
            
        case 'mark_as_read':
            $conversationId = (int)($_POST['conversation_id'] ?? 0);
            markConversationAsRead($pdo, $userId, $conversationId);
            break;
            
        case 'get_unread_count':
            getUnreadCount($pdo, $userId);
            break;
            
        case 'update_status':
            $status = $_POST['status'] ?? 'online';
            updateUserStatus($pdo, $userId, $status);
            break;
            
        case 'get_online_users':
            getOnlineUsers($pdo);
            break;
            
        case 'search_users':
            $query = $_GET['q'] ?? '';
            searchUsers($pdo, $query);
            break;
            
        case 'edit_message':
            if ($jsonData === null) {
                http_response_code(400);
                echo json_encode(['success' => false, 'error' => 'Invalid JSON']);
                break;
            }
            editMessage($pdo, $userId, $jsonData);
            break;
            
        case 'delete_message':
            $messageId = (int)($_POST['message_id'] ?? 0);
            deleteMessage($pdo, $userId, $messageId);
            break;
            
        case 'add_reaction':
            if ($jsonData === null) {
                http_response_code(400);
                echo json_encode(['success' => false, 'error' => 'Invalid JSON']);
                break;
            }
            addReaction($pdo, $userId, $jsonData);
            break;
            
        case 'typing':
            $conversationId = (int)($_POST['conversation_id'] ?? 0);
            updateTypingStatus($pdo, $userId, $conversationId);
            break;
            
        case 'get_typing_users':
            $conversationId = (int)($_GET['conversation_id'] ?? 0);
            getTypingUsers($pdo, $conversationId, $userId);
            break;
            
        case 'send_mass_message':
            if ($jsonData === null) {
                http_response_code(400);
                echo json_encode(['success' => false, 'error' => 'Invalid JSON']);
                break;
            }
            sendMassMessage($pdo, $userId, $jsonData);
            break;

        case 'add_group_member':
            if ($jsonData === null) {
                http_response_code(400);
                echo json_encode(['success' => false, 'error' => 'Invalid JSON']);
                break;
            }
            addGroupMemberFixed($pdo, $userId, $jsonData);
            break;
            
        default:
            http_response_code(400);
            echo json_encode(['success' => false, 'error' => 'Acción no válida']);
    }
} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(['success' => false, 'error' => $e->getMessage()]);
}

// ==================== FUNCIONES ====================

function getConversations(PDO $pdo, int $userId): void {
    $stmt = $pdo->prepare("
        SELECT 
            c.id,
            c.name,
            c.type,
            c.last_message_at,
            (SELECT COUNT(*) FROM chat_messages cm 
             WHERE cm.conversation_id = c.id 
             AND cm.created_at > COALESCE(p.last_read_at, '1970-01-01')
             AND cm.user_id != ?
            ) as unread_count,
            (SELECT cm.message_text FROM chat_messages cm 
             WHERE cm.conversation_id = c.id 
             ORDER BY cm.created_at DESC LIMIT 1
            ) as last_message,
            (SELECT u.username FROM chat_messages cm 
             JOIN users u ON u.id = cm.user_id
             WHERE cm.conversation_id = c.id 
             ORDER BY cm.created_at DESC LIMIT 1
            ) as last_sender,
            CASE 
                WHEN c.type = 'direct' THEN
                    (SELECT u.full_name FROM chat_participants cp2
                     JOIN users u ON u.id = cp2.user_id
                     WHERE cp2.conversation_id = c.id AND cp2.user_id != ? LIMIT 1)
                ELSE c.name
            END as display_name,
            CASE 
                WHEN c.type = 'direct' THEN
                    (SELECT u.id FROM chat_participants cp2
                     JOIN users u ON u.id = cp2.user_id
                     WHERE cp2.conversation_id = c.id AND cp2.user_id != ? LIMIT 1)
                ELSE NULL
            END as other_user_id
        FROM chat_conversations c
        JOIN chat_participants p ON p.conversation_id = c.id
        WHERE p.user_id = ? AND p.is_active = 1 AND c.is_active = 1
        ORDER BY c.last_message_at DESC
    ");
    
    $stmt->execute([$userId, $userId, $userId, $userId]);
    $conversations = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    echo json_encode(['success' => true, 'conversations' => $conversations]);
}

function getMessages(PDO $pdo, int $userId, int $conversationId, int $lastMessageId = 0): void {
    // Verificar que el usuario es participante
    $stmt = $pdo->prepare("
        SELECT id FROM chat_participants 
        WHERE conversation_id = ? AND user_id = ? AND is_active = 1
    ");
    $stmt->execute([$conversationId, $userId]);
    
    if (!$stmt->fetch()) {
        http_response_code(403);
        echo json_encode(['success' => false, 'error' => 'No autorizado']);
        return;
    }
    
    // Obtener mensajes
    $query = "
        SELECT 
            m.id,
            m.user_id,
            m.message_text,
            m.message_type,
            m.is_edited,
            m.is_deleted,
            m.created_at,
            m.parent_message_id,
            u.username,
            u.full_name,
            (SELECT JSON_ARRAYAGG(
                JSON_OBJECT(
                    'id', a.id,
                    'file_name', a.file_name,
                    'file_original_name', a.file_original_name,
                    'file_type', a.file_type,
                    'file_size', a.file_size,
                    'mime_type', a.mime_type,
                    'thumbnail_path', a.thumbnail_path
                )
            ) FROM chat_attachments a WHERE a.message_id = m.id) as attachments,
            (SELECT JSON_ARRAYAGG(
                JSON_OBJECT(
                    'reaction', r.reaction,
                    'user_id', r.user_id,
                    'username', ru.username
                )
            ) FROM chat_reactions r 
            JOIN users ru ON ru.id = r.user_id 
            WHERE r.message_id = m.id) as reactions
        FROM chat_messages m
        JOIN users u ON u.id = m.user_id
        WHERE m.conversation_id = ? AND m.is_deleted = 0
    ";
    
    $params = [$conversationId];
    
    if ($lastMessageId > 0) {
        $query .= " AND m.id > ?";
        $params[] = $lastMessageId;
    }
    
    $query .= " ORDER BY m.created_at ASC LIMIT " . CHAT_MESSAGES_PER_PAGE;
    
    $stmt = $pdo->prepare($query);
    $stmt->execute($params);
    $messages = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    // Procesar attachments y reactions
    foreach ($messages as &$msg) {
        $msg['attachments'] = $msg['attachments'] ? json_decode($msg['attachments'], true) : [];
        $msg['reactions'] = $msg['reactions'] ? json_decode($msg['reactions'], true) : [];
    }
    
    echo json_encode(['success' => true, 'messages' => $messages]);
}

function sendMessage(PDO $pdo, int $userId, array $data): void {
    $conversationId = (int)($data['conversation_id'] ?? 0);
    $messageText = trim($data['message_text'] ?? '');
    $parentMessageId = !empty($data['parent_message_id']) ? (int)$data['parent_message_id'] : null;
    
    if ($conversationId <= 0) {
        http_response_code(400);
        echo json_encode(['success' => false, 'error' => 'ID de conversación inválido']);
        return;
    }
    
    // Verificar permisos
    if (!checkChatPermission($pdo, $userId, 'can_use_chat')) {
        http_response_code(403);
        echo json_encode(['success' => false, 'error' => 'No tienes permiso para usar el chat']);
        return;
    }
    
    // Verificar que es participante
    $stmt = $pdo->prepare("
        SELECT id FROM chat_participants 
        WHERE conversation_id = ? AND user_id = ? AND is_active = 1
    ");
    $stmt->execute([$conversationId, $userId]);
    
    if (!$stmt->fetch()) {
        http_response_code(403);
        echo json_encode(['success' => false, 'error' => 'No autorizado']);
        return;
    }
    
    if (empty($messageText)) {
        http_response_code(400);
        echo json_encode(['success' => false, 'error' => 'El mensaje no puede estar vacío']);
        return;
    }
    
    if (mb_strlen($messageText) > CHAT_MAX_MESSAGE_LENGTH) {
        http_response_code(400);
        echo json_encode(['success' => false, 'error' => 'El mensaje es demasiado largo']);
        return;
    }
    
    // Insertar mensaje
    $stmt = $pdo->prepare("
        INSERT INTO chat_messages (conversation_id, user_id, message_text, parent_message_id)
        VALUES (?, ?, ?, ?)
    ");
    $stmt->execute([$conversationId, $userId, $messageText, $parentMessageId]);
    $messageId = $pdo->lastInsertId();
    
    // Crear notificaciones para otros participantes
    $stmt = $pdo->prepare("
        INSERT INTO chat_notifications (user_id, conversation_id, message_id, notification_type)
        SELECT user_id, ?, ?, 'new_message'
        FROM chat_participants
        WHERE conversation_id = ? AND user_id != ? AND is_active = 1
    ");
    $stmt->execute([$conversationId, $messageId, $conversationId, $userId]);
    
    // Obtener el timestamp exacto del mensaje recién creado
    $stmt = $pdo->prepare("SELECT created_at FROM chat_messages WHERE id = ?");
    $stmt->execute([$messageId]);
    $createdAt = $stmt->fetchColumn();
    
    echo json_encode([
        'success' => true, 
        'message_id' => $messageId,
        'created_at' => $createdAt
    ]);
}

function createConversation(PDO $pdo, int $userId, array $data): void {
    $type = $data['type'] ?? 'direct';
    $name = trim($data['name'] ?? '');
    $participantIds = $data['participants'] ?? [];
    
    if (!in_array($type, ['direct', 'group', 'channel'])) {
        http_response_code(400);
        echo json_encode(['success' => false, 'error' => 'Tipo de conversación inválido']);
        return;
    }
    
    if ($type === 'group' && empty($name)) {
        http_response_code(400);
        echo json_encode(['success' => false, 'error' => 'El nombre del grupo es requerido']);
        return;
    }
    
    if (empty($participantIds)) {
        http_response_code(400);
        echo json_encode(['success' => false, 'error' => 'Debes seleccionar al menos un participante']);
        return;
    }
    
    // Verificar permiso para crear grupos
    if ($type === 'group' && !checkChatPermission($pdo, $userId, 'can_create_groups')) {
        http_response_code(403);
        echo json_encode(['success' => false, 'error' => 'No tienes permiso para crear grupos']);
        return;
    }
    
    $pdo->beginTransaction();
    
    try {
        // Para conversaciones directas, verificar si ya existe
        if ($type === 'direct' && count($participantIds) === 1) {
            $otherUserId = (int)$participantIds[0];
            
            $stmt = $pdo->prepare("
                SELECT c.id 
                FROM chat_conversations c
                JOIN chat_participants p1 ON p1.conversation_id = c.id
                JOIN chat_participants p2 ON p2.conversation_id = c.id
                WHERE c.type = 'direct' 
                AND p1.user_id = ? 
                AND p2.user_id = ?
                AND c.is_active = 1
                LIMIT 1
            ");
            $stmt->execute([$userId, $otherUserId]);
            $existing = $stmt->fetch();
            
            if ($existing) {
                $pdo->rollBack();
                echo json_encode(['success' => true, 'conversation_id' => $existing['id'], 'existing' => true]);
                return;
            }
        }
        
        // Crear conversación
        $stmt = $pdo->prepare("
            INSERT INTO chat_conversations (type, name, created_by)
            VALUES (?, ?, ?)
        ");
        $stmt->execute([$type, $name ?: null, $userId]);
        $conversationId = $pdo->lastInsertId();
        
        // Agregar creador como admin
        $stmt = $pdo->prepare("
            INSERT INTO chat_participants (conversation_id, user_id, role)
            VALUES (?, ?, 'admin')
        ");
        $stmt->execute([$conversationId, $userId]);
        
        // Agregar otros participantes
        $stmt = $pdo->prepare("
            INSERT INTO chat_participants (conversation_id, user_id, role)
            VALUES (?, ?, 'member')
        ");
        
        foreach ($participantIds as $participantId) {
            $participantId = (int)$participantId;
            if ($participantId !== $userId) {
                $stmt->execute([$conversationId, $participantId]);
            }
        }
        
        $pdo->commit();
        
        echo json_encode(['success' => true, 'conversation_id' => $conversationId]);
        
    } catch (Exception $e) {
        $pdo->rollBack();
        throw $e;
    }
}

function markConversationAsRead(PDO $pdo, int $userId, int $conversationId): void {
    $stmt = $pdo->prepare("
        UPDATE chat_participants
        SET last_read_at = NOW()
        WHERE conversation_id = ? AND user_id = ?
    ");
    $stmt->execute([$conversationId, $userId]);
    
    echo json_encode(['success' => true]);
}

function getUnreadCount(PDO $pdo, int $userId): void {
    // Contar mensajes no leídos de todas las conversaciones del usuario
    $stmt = $pdo->prepare("
        SELECT COUNT(*) as count
        FROM chat_messages cm
        JOIN chat_participants p ON p.conversation_id = cm.conversation_id
        WHERE p.user_id = ? 
        AND p.is_active = 1
        AND cm.user_id != ?
        AND cm.created_at > COALESCE(p.last_read_at, '1970-01-01')
        AND cm.is_deleted = 0
    ");
    $stmt->execute([$userId, $userId]);
    $result = $stmt->fetch();
    
    echo json_encode(['success' => true, 'unread_count' => (int)$result['count']]);
}

function updateUserStatus(PDO $pdo, int $userId, string $status): void {
    if (!in_array($status, ['online', 'offline', 'away', 'busy'])) {
        $status = 'online';
    }
    
    $stmt = $pdo->prepare("
        INSERT INTO chat_user_status (user_id, status, last_seen)
        VALUES (?, ?, NOW())
        ON DUPLICATE KEY UPDATE status = ?, last_seen = NOW()
    ");
    $stmt->execute([$userId, $status, $status]);
    
    echo json_encode(['success' => true]);
}

function getOnlineUsers(PDO $pdo): void {
    $stmt = $pdo->query("
        SELECT 
            u.id,
            u.username,
            u.full_name,
            u.role,
            COALESCE(s.status, 'offline') as status,
            s.last_seen
        FROM users u
        LEFT JOIN chat_user_status s ON s.user_id = u.id
        WHERE u.is_active = 1
        ORDER BY 
            CASE 
                WHEN s.status = 'online' THEN 1
                WHEN s.last_seen > DATE_SUB(NOW(), INTERVAL " . CHAT_ONLINE_THRESHOLD . " SECOND) THEN 2
                ELSE 3
            END,
            u.full_name
    ");
    
    $users = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    // Marcar como online si tiene actividad reciente
    foreach ($users as &$user) {
        if ($user['last_seen'] && strtotime($user['last_seen']) > time() - CHAT_ONLINE_THRESHOLD) {
            $user['is_online'] = true;
        } else {
            $user['is_online'] = ($user['status'] === 'online');
        }
    }
    
    echo json_encode(['success' => true, 'users' => $users]);
}

function searchUsers(PDO $pdo, string $query): void {
    $query = '%' . $query . '%';
    
    $stmt = $pdo->prepare("
        SELECT id, username, full_name, role
        FROM users
        WHERE (username LIKE ? OR full_name LIKE ?)
        AND is_active = 1
        ORDER BY full_name
        LIMIT 20
    ");
    $stmt->execute([$query, $query]);
    $users = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    echo json_encode(['success' => true, 'users' => $users]);
}

function editMessage(PDO $pdo, int $userId, array $data): void {
    $messageId = (int)($data['message_id'] ?? 0);
    $newText = trim($data['message_text'] ?? '');
    
    if (empty($newText)) {
        http_response_code(400);
        echo json_encode(['success' => false, 'error' => 'El mensaje no puede estar vacío']);
        return;
    }
    
    // Verificar que el usuario es el autor
    $stmt = $pdo->prepare("SELECT user_id FROM chat_messages WHERE id = ?");
    $stmt->execute([$messageId]);
    $message = $stmt->fetch();
    
    if (!$message || $message['user_id'] != $userId) {
        http_response_code(403);
        echo json_encode(['success' => false, 'error' => 'No autorizado']);
        return;
    }
    
    $stmt = $pdo->prepare("
        UPDATE chat_messages
        SET message_text = ?, is_edited = 1, edited_at = NOW()
        WHERE id = ?
    ");
    $stmt->execute([$newText, $messageId]);
    
    echo json_encode(['success' => true]);
}

function deleteMessage(PDO $pdo, int $userId, int $messageId): void {
    // Verificar que el usuario es el autor
    $stmt = $pdo->prepare("SELECT user_id FROM chat_messages WHERE id = ?");
    $stmt->execute([$messageId]);
    $message = $stmt->fetch();
    
    if (!$message || $message['user_id'] != $userId) {
        http_response_code(403);
        echo json_encode(['success' => false, 'error' => 'No autorizado']);
        return;
    }
    
    $stmt = $pdo->prepare("
        UPDATE chat_messages
        SET is_deleted = 1, deleted_at = NOW(), message_text = '[Mensaje eliminado]'
        WHERE id = ?
    ");
    $stmt->execute([$messageId]);
    
    echo json_encode(['success' => true]);
}

function addReaction(PDO $pdo, int $userId, array $data): void {
    $messageId = (int)($data['message_id'] ?? 0);
    $reaction = trim($data['reaction'] ?? '');
    
    if (empty($reaction)) {
        http_response_code(400);
        echo json_encode(['success' => false, 'error' => 'Reacción inválida']);
        return;
    }
    
    try {
        $stmt = $pdo->prepare("
            INSERT INTO chat_reactions (message_id, user_id, reaction)
            VALUES (?, ?, ?)
            ON DUPLICATE KEY UPDATE reaction = ?
        ");
        $stmt->execute([$messageId, $userId, $reaction, $reaction]);
        
        echo json_encode(['success' => true]);
    } catch (PDOException $e) {
        // Si ya existe, eliminar la reacción
        $stmt = $pdo->prepare("
            DELETE FROM chat_reactions
            WHERE message_id = ? AND user_id = ? AND reaction = ?
        ");
        $stmt->execute([$messageId, $userId, $reaction]);
        
        echo json_encode(['success' => true, 'removed' => true]);
    }
}

function updateTypingStatus(PDO $pdo, int $userId, int $conversationId): void {
    // Guardar en cache temporal (puedes usar Redis o memcached en producción)
    $cacheKey = "typing_{$conversationId}_{$userId}";
    $cacheFile = sys_get_temp_dir() . "/{$cacheKey}";
    file_put_contents($cacheFile, time());
    
    echo json_encode(['success' => true]);
}

function getTypingUsers(PDO $pdo, int $conversationId, int $userId): void {
    $typingUsers = [];
    $tempDir = sys_get_temp_dir();
    $pattern = "typing_{$conversationId}_*";
    $currentTime = time();
    
    foreach (glob("{$tempDir}/{$pattern}") as $file) {
        $lastUpdate = (int)file_get_contents($file);
        
        // Si fue actualizado en los últimos 5 segundos
        if (($currentTime - $lastUpdate) < 5) {
            preg_match('/typing_\d+_(\d+)/', basename($file), $matches);
            if (!empty($matches[1]) && (int)$matches[1] !== $userId) {
                $typingUserId = (int)$matches[1];
                
                $stmt = $pdo->prepare("SELECT full_name FROM users WHERE id = ?");
                $stmt->execute([$typingUserId]);
                $user = $stmt->fetch();
                
                if ($user) {
                    $typingUsers[] = $user['full_name'];
                }
            }
        } else {
            // Limpiar archivos antiguos
            @unlink($file);
        }
    }
    
    echo json_encode(['success' => true, 'typing_users' => $typingUsers]);
}

function sendMassMessage(PDO $pdo, int $userId, array $data): void {
    $messageText = trim($data['message_text'] ?? '');
    
    if (empty($messageText)) {
        http_response_code(400);
        echo json_encode(['success' => false, 'error' => 'El mensaje no puede estar vacío']);
        return;
    }
    
    // Verificar permiso de mensajes masivos
    require_once __DIR__ . '/../lib/authorization_functions.php';
    if (!userHasPermission('chat_mass_message')) {
        http_response_code(403);
        echo json_encode(['success' => false, 'error' => 'No tienes permiso para enviar mensajes masivos']);
        return;
    }
    
    if (mb_strlen($messageText) > CHAT_MAX_MESSAGE_LENGTH) {
        http_response_code(400);
        echo json_encode(['success' => false, 'error' => 'El mensaje es demasiado largo']);
        return;
    }
    
    try {
        $pdo->beginTransaction();
        
        // Obtener todos los usuarios activos excepto el remitente
        $stmt = $pdo->prepare("
            SELECT id, full_name, username 
            FROM users 
            WHERE id != ? AND is_active = 1
            ORDER BY full_name
        ");
        $stmt->execute([$userId]);
        $users = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        if (empty($users)) {
            $pdo->rollBack();
            echo json_encode(['success' => false, 'error' => 'No hay usuarios disponibles para enviar el mensaje']);
            return;
        }
        
        $sentCount = 0;
        $errors = [];
        
        // Crear conversación individual con cada usuario y enviar mensaje
        foreach ($users as $user) {
            try {
                // Verificar si ya existe una conversación directa entre estos usuarios
                $conversationStmt = $pdo->prepare("
                    SELECT c.id 
                    FROM chat_conversations c
                    JOIN chat_participants p1 ON p1.conversation_id = c.id AND p1.user_id = ?
                    JOIN chat_participants p2 ON p2.conversation_id = c.id AND p2.user_id = ?
                    WHERE c.type = 'direct' AND c.is_active = 1
                    LIMIT 1
                ");
                $conversationStmt->execute([$userId, $user['id']]);
                $conversation = $conversationStmt->fetch();
                
                $conversationId = null;
                
                if ($conversation) {
                    $conversationId = $conversation['id'];
                } else {
                    // Crear nueva conversación directa
                    $createConvStmt = $pdo->prepare("
                        INSERT INTO chat_conversations (name, type, created_by) 
                        VALUES (?, 'direct', ?)
                    ");
                    $createConvStmt->execute([null, $userId]);
                    $conversationId = $pdo->lastInsertId();
                    
                    // Agregar participantes
                    $addParticipantStmt = $pdo->prepare("
                        INSERT INTO chat_participants (conversation_id, user_id, joined_at) 
                        VALUES (?, ?, NOW())
                    ");
                    $addParticipantStmt->execute([$conversationId, $userId]);
                    $addParticipantStmt->execute([$conversationId, $user['id']]);
                }
                
                // Enviar mensaje
                $messageStmt = $pdo->prepare("
                    INSERT INTO chat_messages (conversation_id, user_id, message_text, message_type) 
                    VALUES (?, ?, ?, 'mass_message')
                ");
                $messageStmt->execute([$conversationId, $userId, $messageText]);
                $messageId = $pdo->lastInsertId();
                
                // Crear notificación
                $notificationStmt = $pdo->prepare("
                    INSERT INTO chat_notifications (user_id, conversation_id, message_id, notification_type) 
                    VALUES (?, ?, ?, 'mass_message')
                ");
                $notificationStmt->execute([$user['id'], $conversationId, $messageId]);
                
                // Actualizar timestamp de la conversación
                $updateConvStmt = $pdo->prepare("
                    UPDATE chat_conversations 
                    SET last_message_at = NOW() 
                    WHERE id = ?
                ");
                $updateConvStmt->execute([$conversationId]);
                
                $sentCount++;
                
            } catch (Exception $e) {
                $errors[] = "Error enviando a {$user['full_name']}: " . $e->getMessage();
                error_log("Mass message error for user {$user['id']}: " . $e->getMessage());
            }
        }
        
        $pdo->commit();
        
        // Registrar la actividad de mensaje masivo
        try {
            $logStmt = $pdo->prepare("
                INSERT INTO activity_logs (user_id, action, details, ip_address) 
                VALUES (?, 'mass_message_sent', ?, ?)
            ");
            $logDetails = json_encode([
                'message_preview' => mb_substr($messageText, 0, 100),
                'recipients_count' => $sentCount,
                'total_users' => count($users),
                'errors_count' => count($errors)
            ]);
            $logStmt->execute([$userId, $logDetails, $_SERVER['REMOTE_ADDR'] ?? 'unknown']);
        } catch (Exception $e) {
            error_log("Failed to log mass message activity: " . $e->getMessage());
        }
        
        $response = [
            'success' => true,
            'message' => "Mensaje enviado exitosamente a {$sentCount} usuarios",
            'sent_count' => $sentCount,
            'total_users' => count($users)
        ];
        
        if (!empty($errors)) {
            $response['warnings'] = $errors;
        }
        
        echo json_encode($response);
        
    } catch (Exception $e) {
        $pdo->rollBack();
        error_log("Mass message transaction error: " . $e->getMessage());
        http_response_code(500);
        echo json_encode(['success' => false, 'error' => 'Error interno del servidor al enviar mensajes masivos']);
    }
}

function checkChatPermission(PDO $pdo, int $userId, string $permission): bool {
    try {
        $stmt = $pdo->prepare("
            SELECT {$permission}, is_restricted, restricted_until
            FROM chat_permissions
            WHERE user_id = ?
        ");
        $stmt->execute([$userId]);
        $perms = $stmt->fetch();
        
        if (!$perms) {
            // Si no hay registro, verificar el rol del usuario
            $userStmt = $pdo->prepare("SELECT role FROM users WHERE id = ?");
            $userStmt->execute([$userId]);
            $user = $userStmt->fetch();
            
            // Solo ADMIN y SUPERVISOR tienen permisos por defecto para crear grupos
            // AGENT y otros roles deben tener un registro explícito
            if ($permission === 'can_create_groups') {
                return in_array($user['role'] ?? '', ['ADMIN', 'SUPERVISOR']);
            }
            
            // Otros permisos por defecto permitir
            return true;
        }
        
        if ($perms['is_restricted']) {
            if ($perms['restricted_until'] && strtotime($perms['restricted_until']) > time()) {
                return false;
            }
        }
        
        return (bool)$perms[$permission];
    } catch (Exception $e) {
        // Si la tabla no existe o hay error, denegar por seguridad
        error_log("Chat permission check error: " . $e->getMessage());
        return false;
    }
}

// Re-implementación estable de agregar miembro al grupo
function addGroupMemberFixed(PDO $pdo, int $userId, array $data): void {
    $conversationId = (int)($data['conversation_id'] ?? 0);
    $newMemberId = (int)($data['user_id'] ?? 0);

    if ($conversationId <= 0 || $newMemberId <= 0) {
        http_response_code(400);
        echo json_encode(['success' => false, 'error' => 'Datos inválidos']);
        return;
    }

    try {
        $pdo->beginTransaction();

        // 1) Validar que es grupo
        $stmtConv = $pdo->prepare("SELECT type, name FROM chat_conversations WHERE id = ? AND is_active = 1");
        $stmtConv->execute([$conversationId]);
        $conv = $stmtConv->fetch(PDO::FETCH_ASSOC);
        if (!$conv || ($conv['type'] ?? '') !== 'group') {
            throw new Exception('Conversación no válida o no es un grupo');
        }

        // 2) Validar permisos del solicitante (admin del grupo)
        $stmtRole = $pdo->prepare("SELECT role FROM chat_participants WHERE conversation_id = ? AND user_id = ? AND is_active = 1");
        $stmtRole->execute([$conversationId, $userId]);
        $roleRow = $stmtRole->fetch(PDO::FETCH_ASSOC);
        if (!$roleRow) {
            throw new Exception('No eres miembro de este grupo');
        }
        if (($roleRow['role'] ?? 'member') !== 'admin') {
            throw new Exception('Solo los administradores del grupo pueden agregar miembros');
        }

        // 3) Reactivar o insertar participante
        $stmtCheck = $pdo->prepare("SELECT id, is_active FROM chat_participants WHERE conversation_id = ? AND user_id = ?");
        $stmtCheck->execute([$conversationId, $newMemberId]);
        $existing = $stmtCheck->fetch(PDO::FETCH_ASSOC);

        if ($existing) {
            if ((int)$existing['is_active'] === 1) {
                throw new Exception('El usuario ya es miembro del grupo');
            }
            $stmtReactivate = $pdo->prepare("UPDATE chat_participants SET is_active = 1, joined_at = NOW(), role = 'member' WHERE id = ?");
            $stmtReactivate->execute([$existing['id']]);
        } else {
            $stmtInsert = $pdo->prepare("INSERT INTO chat_participants (conversation_id, user_id, role, joined_at) VALUES (?, ?, 'member', NOW())");
            $stmtInsert->execute([$conversationId, $newMemberId]);
        }

        // 4) Mensaje del sistema
        $stmtUser = $pdo->prepare("SELECT full_name FROM users WHERE id = ?");
        $stmtUser->execute([$newMemberId]);
        $newMemberName = $stmtUser->fetchColumn() ?: 'Usuario';
        $systemMessage = "ha agregado a {$newMemberName} al grupo";

        $stmtMsg = $pdo->prepare("INSERT INTO chat_messages (conversation_id, user_id, message_text, message_type) VALUES (?, ?, ?, 'system')");
        $stmtMsg->execute([$conversationId, $userId, $systemMessage]);

        $pdo->commit();
        echo json_encode(['success' => true]);
    } catch (Exception $e) {
        if ($pdo->inTransaction()) {
            $pdo->rollBack();
        }
        http_response_code(400);
        echo json_encode(['success' => false, 'error' => $e->getMessage()]);
    }
}

 
 f u n c t i o n   a d d G r o u p M e m b e r ( P D O   $ p d o ,   i n t   $ u s e r I d ,   a r r a y   $ d a t a ) :   v o i d   { 
 
         $ c o n v e r s a t i o n I d   =   ( i n t ) ( $ d a t a [ ' c o n v e r s a t i o n _ i d ' ]   ? ?   0 ) ; 
 
         $ n e w M e m b e r I d   =   ( i n t ) ( $ d a t a [ ' u s e r _ i d ' ]   ? ?   0 ) ; 
 
 
 
         i f   ( $ c o n v e r s a t i o n I d   < =   0   | |   $ n e w M e m b e r I d   < =   0 )   { 
 
                 h t t p _ r e s p o n s e _ c o d e ( 4 0 0 ) ; 
 
                 e c h o   j s o n _ e n c o d e ( [ ' s u c c e s s '   = >   f a l s e ,   ' e r r o r '   = >   ' D a t o s   i n v � � l i d o s ' ] ) ; 
 
                 r e t u r n ; 
 
         } 
 
 
 
         t r y   { 
 
                 $ p d o - > b e g i n T r a n s a c t i o n ( ) ; 
 
 
 
                 / /   1 .   V e r i f i c a r   q u e   l a   c o n v e r s a c i � � n   e x i s t e   y   e s   u n   g r u p o 
 
                 $ s t m t   =   $ p d o - > p r e p a r e ( " 
 
                         S E L E C T   t y p e ,   n a m e   
 
                         F R O M   c h a t _ c o n v e r s a t i o n s   
 
                         W H E R E   i d   =   ?   A N D   i s _ a c t i v e   =   1 
 
                 " ) ; 
 
                 $ s t m t - > e x e c u t e ( [ $ c o n v e r s a t i o n I d ] ) ; 
 
                 $ c o n v e r s a t i o n   =   $ s t m t - > f e t c h ( ) ; 
 
 
 
                 i f   ( ! $ c o n v e r s a t i o n   | |   $ c o n v e r s a t i o n [ ' t y p e ' ]   ! = =   ' g r o u p ' )   { 
 
                         t h r o w   n e w   E x c e p t i o n ( ' C o n v e r s a c i � � n   n o   v � � l i d a   o   n o   e s   u n   g r u p o ' ) ; 
 
                 } 
 
 
 
                 / /   2 .   V e r i f i c a r   p e r m i s o s   d e l   s o l i c i t a n t e   ( d e b e   s e r   a d m i n   d e l   g r u p o   o   s u p e r a d m i n ) 
 
                 / /   P r i m e r o   v e r i f i c a m o s   s i   e s   p a r t i c i p a n t e   y   s u   r o l 
 
                 $ s t m t   =   $ p d o - > p r e p a r e ( " 
 
                         S E L E C T   r o l e   
 
                         F R O M   c h a t _ p a r t i c i p a n t s   
 
                         W H E R E   c o n v e r s a t i o n _ i d   =   ?   A N D   u s e r _ i d   =   ?   A N D   i s _ a c t i v e   =   1 
 
                 " ) ; 
 
                 $ s t m t - > e x e c u t e ( [ $ c o n v e r s a t i o n I d ,   $ u s e r I d ] ) ; 
 
                 $ p a r t i c i p a n t   =   $ s t m t - > f e t c h ( ) ; 
 
 
 
                 / /   S i   n o   e s   p a r t i c i p a n t e   a c t i v o ,   v e r i f i c a r   s i   e s   s u p e r a d m i n   d e l   s i s t e m a   ( o p c i o n a l ,   p o r   a h o r a   r e s t r i n g i m o s   a   p a r t i c i p a n t e s ) 
 
                 i f   ( ! $ p a r t i c i p a n t )   { 
 
                         t h r o w   n e w   E x c e p t i o n ( ' N o   e r e s   m i e m b r o   d e   e s t e   g r u p o ' ) ; 
 
                 } 
 
 
 
                 / /   V e r i f i c a r   s i   e s   a d m i n   d e l   g r u p o 
 
                 i f   ( $ p a r t i c i p a n t [ ' r o l e ' ]   ! = =   ' a d m i n ' )   { 
 
                         / /   A q u � �   p o d r � � a s   a g r e g a r   l � � g i c a   p a r a   p e r m i t i r   a   c u a l q u i e r   m i e m b r o   a g r e g a r   s i   a s � �   s e   d e s e a 
 
                         / /   P o r   a h o r a ,   s o l o   a d m i n s   d e l   g r u p o 
 
                         t h r o w   n e w   E x c e p t i o n ( ' S o l o   l o s   a d m i n i s t r a d o r e s   d e l   g r u p o   p u e d e n   a g r e g a r   m i e m b r o s ' ) ; 
 
                 } 
 
 
 
                 / /   3 .   V e r i f i c a r   s i   e l   n u e v o   m i e m b r o   y a   e s t � �   e n   e l   g r u p o 
 
                 $ s t m t   =   $ p d o - > p r e p a r e ( " 
 
                         S E L E C T   i d ,   i s _ a c t i v e   
 
                         F R O M   c h a t _ p a r t i c i p a n t s   
 
                         W H E R E   c o n v e r s a t i o n _ i d   =   ?   A N D   u s e r _ i d   =   ? 
 
                 " ) ; 
 
                 $ s t m t - > e x e c u t e ( [ $ c o n v e r s a t i o n I d ,   $ n e w M e m b e r I d ] ) ; 
 
                 $ e x i s t i n g M e m b e r   =   $ s t m t - > f e t c h ( ) ; 
 
 
 
                 i f   ( $ e x i s t i n g M e m b e r   & &   $ e x i s t i n g M e m b e r [ ' i s _ a c t i v e ' ] )   { 
 
                         t h r o w   n e w   E x c e p t i o n ( ' E l   u s u a r i o   y a   e s   m i e m b r o   d e l   g r u p o ' ) ; 
 
                 } 
 
 
 
                 / /   4 .   A g r e g a r   o   r e a c t i v a r   m i e m b r o 
 
                 i f   ( $ e x i s t i n g M e m b e r )   { 
 
                         / /   R e a c t i v a r 
 
                         $ s t m t   =   $ p d o - > p r e p a r e ( " 
 
                                 U P D A T E   c h a t _ p a r t i c i p a n t s   
 
                                 S E T   i s _ a c t i v e   =   1 ,   j o i n e d _ a t   =   N O W ( ) ,   r o l e   =   ' m e m b e r ' 
 
                                 W H E R E   i d   =   ? 
 
                         " ) ; 
 
                         $ s t m t - > e x e c u t e ( [ $ e x i s t i n g M e m b e r [ ' i d ' ] ] ) ; 
 
                 }   e l s e   { 
 
                         / /   I n s e r t a r   n u e v o 
 
                         $ s t m t   =   $ p d o - > p r e p a r e ( " 
 
                                 I N S E R T   I N T O   c h a t _ p a r t i c i p a n t s   ( c o n v e r s a t i o n _ i d ,   u s e r _ i d ,   r o l e ,   j o i n e d _ a t ) 
 
                                 V A L U E S   ( ? ,   ? ,   ' m e m b e r ' ,   N O W ( ) ) 
 
                         " ) ; 
 
                         $ s t m t - > e x e c u t e ( [ $ c o n v e r s a t i o n I d ,   $ n e w M e m b e r I d ] ) ; 
 
                 } 
 
 
 
                 / /   5 .   O b t e n e r   n o m b r e   d e l   n u e v o   m i e m b r o   p a r a   e l   m e n s a j e   d e l   s i s t e m a 
 
                 $ s t m t   =   $ p d o - > p r e p a r e ( " S E L E C T   f u l l _ n a m e   F R O M   u s e r s   W H E R E   i d   =   ? " ) ; 
 
                 $ s t m t - > e x e c u t e ( [ $ n e w M e m b e r I d ] ) ; 
 
                 $ n e w M e m b e r N a m e   =   $ s t m t - > f e t c h C o l u m n ( ) ; 
 
 
 
                 / /   6 .   I n s e r t a r   m e n s a j e   d e l   s i s t e m a 
 
                 $ s y s t e m M e s s a g e   =   " a � � a d i � �   a   { $ n e w M e m b e r N a m e }   a l   g r u p o " ; 
 
                 $ s t m t   =   $ p d o - > p r e p a r e ( " 
 
                         I N S E R T   I N T O   c h a t _ m e s s a g e s   ( c o n v e r s a t i o n _ i d ,   u s e r _ i d ,   m e s s a g e _ t e x t ,   m e s s a g e _ t y p e ) 
 
                         V A L U E S   ( ? ,   ? ,   ? ,   ' s y s t e m ' ) 
 
                 " ) ; 
 
                 $ s t m t - > e x e c u t e ( [ $ c o n v e r s a t i o n I d ,   $ u s e r I d ,   $ s y s t e m M e s s a g e ] ) ; 
 
                 $ m e s s a g e I d   =   $ p d o - > l a s t I n s e r t I d ( ) ; 
 
 
 
                 / /   7 .   N o t i f i c a r   a   t o d o s   l o s   m i e m b r o s   ( i n c l u y e n d o   a l   n u e v o ) 
 
                 / /   ( L a   l � � g i c a   d e   n o t i f i c a c i o n e s   p o d r � � a   s e r   m � � s   c o m p l e j a ,   p e r o   e s t o   e s   b � � s i c o ) 
 
                 / /   P o d r � � a m o s   r e u t i l i z a r   l a   l � � g i c a   d e   s e n d M e s s a g e   o   h a c e r l o   a q u � � 
 
                 
 
                 $ p d o - > c o m m i t ( ) ; 
 
 
 
                 e c h o   j s o n _ e n c o d e ( [ ' s u c c e s s '   = >   t r u e ] ) ; 
 
 
 
         }   c a t c h   ( E x c e p t i o n   $ e )   { 
 
                 $ p d o - > r o l l B a c k ( ) ; 
 
                 h t t p _ r e s p o n s e _ c o d e ( 4 0 0 ) ; 
 
                 e c h o   j s o n _ e n c o d e ( [ ' s u c c e s s '   = >   f a l s e ,   ' e r r o r '   = >   $ e - > g e t M e s s a g e ( ) ] ) ; 
 
         } 
 
 } 
 
 
